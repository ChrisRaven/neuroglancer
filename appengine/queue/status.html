<!DOCTYPE html>
<html>
<head>
	<title>{{ tqname }} Task Queue Status</title>

	<style>
		table {
			border: 1px solid black;
			border-collapse: collapse;
		}
		td,th {
			border: 1px solid black;
			padding: 5px;
			text-align: center;
		}

	</style>

	<script type="text/javascript">
		var STATE = {
			tqname: '{{ tqname }}',
			enqueued: {{ enqueued }},
			leased: {
				outstanding: {{ leases_outstanding }},
				60: {{ one_min }},
				600: {{ ten_min }},
				3600: {{ one_hr }},
			},
			timestamp: (new Date()).getTime(),
		};

		var BASEURL = 'http://queue-dot-neuromancer-seung-import.appspot.com/s~neuromancer-seung-import/taskqueue';

		function $(elem) {
			if (elem[0] == '#') {
				return document.getElementById(elem.slice(1));
			}
			else if (elem[0] == '.') {
				return document.getElementsByClassName(elem.slice(1));
			}
		}

		function purge () {
			if (confirm("Really delete all tasks?")) {
				fetch(`${BASEURL}/${STATE.tqname}/purge`, {
					method: 'POST',
				})
				.then( () => update() );
			}
		}

		function update () {
			let url = `${BASEURL}/${STATE.tqname}`;
			fetch(url)
				.then( (resp) => resp.json() )
				.then( (resp) => { 
					STATE.enqueued = resp['stats']['totalTasks'];
					STATE.leased = resp['stats']['leasedInLast'];
					STATE.leased.outstanding = resp['stats']['leasesOutstanding'];
					STATE.timestamp = (new Date()).getTime();
				});

			fetch(`${url}/tasks`)
				.then( resp => resp.json() )
				.then( resp => {
					STATE.tasks = resp;
				})
		}

		requestAnimationFrame(function render() {
			$('#enqueued').textContent = STATE.enqueued;
			$('#outstanding').textContent = STATE.leased.outstanding;
			$('#leased').textContent = `${STATE.leased[60]} | ${STATE.leased[600]} | ${STATE.leased[3600]}`;

			let sec = STATE.enqueued / STATE.leased[60]; 
			let t = new Date(STATE.timestamp + sec * 1000);
			let time = t.toLocaleTimeString();

			let eta = '';

			if (sec > 3600) {
				let hrs = sec / 3600
				eta = hrs.toFixed(1) + ' hrs.';
			}
			else if (sec > 60) {
				let min = sec / 60;
				eta = min.toFixed(1) + ' min.';
			}
			else {
				eta = sec.toFixed(1) + ' sec.';
			}

			$('#eta').textContent = `${eta} (${time})`;

			$('#tasks').textContent = JSON.stringify(STATE.tasks);

			requestAnimationFrame(render);
		});

		setInterval(update, 2 * 1000);
	</script>
</head>
<body>
	<h1>{{ tqname }} Status</h1>
	<table>
		<tr>
			<th>Enqueued Tasks</th>
			<th>Leases Outstanding</th>
			<th>Leased Last 1m|10m|1hr</th>
			<th>ETA</th>
		</tr>
		<tr>
			<td id='enqueued'>{{ enqueued }}</td>
			<td id='outstanding'>{{ leases_outstanding }}</td>
			<td id='leased'>{{ one_min }} | {{ ten_min }} | {{ one_hr }}</td>
			<td id='eta'></td>
		</tr>
	</table>

	<h1>Controls</h1>

	<div>
		<button id='purge' onclick="purge()">Purge Queue</button>
		<button id='refresh' onclick="update()">Refresh</button>
	</div>

	<h1>Queue</h1>
	<div id="tasks"></div>
</body>
</html>